<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶Ü DuckBot Cost Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .cost-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .cost-card h3 {
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .cost-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        
        .metric-label {
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .metric-value {
            font-weight: bold;
            color: var(--accent);
            font-family: 'Fira Code', monospace;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .chart-container img {
            max-width: 100%;
            border-radius: 8px;
            background: white;
        }
        
        .budget-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .budget-form input {
            flex: 1;
            min-width: 120px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-style: italic;
        }
        
        .error {
            color: var(--danger);
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <header>
        <h1>
            <span class="status-indicator status-online"></span>
            DuckBot Cost Dashboard
        </h1>
        <nav>
            <a href="/">üìä AI Dashboard</a>
            <a href="/cost">üí∞ Cost Tracking</a>
            <a href="/settings">‚öôÔ∏è Settings</a>
            <button id="refreshData" class="primary" data-tooltip="Refresh cost data">üîÑ Refresh</button>
            <button id="exportReport" class="success" data-tooltip="Download cost report">üìä Export</button>
        </nav>
    </header>

    <main>
        <section class="panel">
            <h2>üí∞ Cost Overview</h2>
            <div class="actions" style="margin-bottom: 20px;">
                <label>Time Period:
                    <select id="daySelect">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </label>
            </div>
            
            <div class="cost-grid">
                <div class="cost-card">
                    <h3>üí∏ Cost Summary</h3>
                    <div id="costMetrics">
                        <div class="loading">Loading cost data...</div>
                    </div>
                </div>
                
                <div class="cost-card">
                    <h3>üìä Usage Statistics</h3>
                    <div id="usageMetrics">
                        <div class="loading">Loading usage data...</div>
                    </div>
                </div>
                
                <div class="cost-card">
                    <h3>üéØ Budget Status</h3>
                    <div id="budgetStatus">
                        <div class="loading">Loading budget status...</div>
                    </div>
                    <div class="budget-form">
                        <input type="number" id="budgetAmount" placeholder="Monthly budget ($)" step="0.01">
                        <input type="number" id="budgetThreshold" placeholder="Alert %" value="80" min="1" max="100">
                        <button onclick="setBudget()" class="primary">Set Budget</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="panel">
            <h2>üìà Cost Dashboard</h2>
            <div class="chart-container" id="costChartContainer">
                <div class="loading">Loading cost dashboard...</div>
            </div>
        </section>

        <section class="panel">
            <h2>üîç Model Cost Comparison</h2>
            <div class="chart-container" id="modelComparisonContainer">
                <div class="loading">Loading model comparison...</div>
            </div>
        </section>

        <section class="panel">
            <h2>üìÖ Usage Patterns</h2>
            <div class="chart-container" id="usagePatternsContainer">
                <div class="loading">Loading usage patterns...</div>
            </div>
        </section>
    </main>

    <script>
        let currentDays = 30;
        
        async function fetchApi(endpoint) {
            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        async function loadCostSummary() {
            try {
                const data = await fetchApi(`/api/cost_summary?days=${currentDays}`);
                const summary = data.data;
                
                document.getElementById('costMetrics').innerHTML = `
                    <div class="cost-metric">
                        <span class="metric-label">Total Cost</span>
                        <span class="metric-value">$${summary.total_cost.toFixed(4)}</span>
                    </div>
                    <div class="cost-metric">
                        <span class="metric-label">Daily Average</span>
                        <span class="metric-value">$${(summary.total_cost / currentDays).toFixed(4)}</span>
                    </div>
                    <div class="cost-metric">
                        <span class="metric-label">Projected Monthly</span>
                        <span class="metric-value">$${(summary.predictions?.current_trends?.monthly_projected || 0).toFixed(2)}</span>
                    </div>
                `;
                
                document.getElementById('usageMetrics').innerHTML = `
                    <div class="cost-metric">
                        <span class="metric-label">Total Tokens</span>
                        <span class="metric-value">${summary.total_tokens.toLocaleString()}</span>
                    </div>
                    <div class="cost-metric">
                        <span class="metric-label">Total Requests</span>
                        <span class="metric-value">${summary.total_requests.toLocaleString()}</span>
                    </div>
                    <div class="cost-metric">
                        <span class="metric-label">Avg. Tokens/Request</span>
                        <span class="metric-value">${Math.round(summary.total_tokens / Math.max(summary.total_requests, 1))}</span>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('costMetrics').innerHTML = `<div class="error">Error loading cost data</div>`;
                document.getElementById('usageMetrics').innerHTML = `<div class="error">Error loading usage data</div>`;
            }
        }
        
        async function loadBudgetStatus() {
            try {
                const data = await fetchApi('/api/budget_status');
                const status = data.data;
                
                if (status.status === 'no_budget_set') {
                    document.getElementById('budgetStatus').innerHTML = `
                        <div class="cost-metric">
                            <span class="metric-label">Status</span>
                            <span class="metric-value">No budget set</span>
                        </div>
                    `;
                } else {
                    const statusClass = status.over_budget ? 'status-offline' : 
                                       status.needs_alert ? 'status-warning' : 'status-online';
                    const statusText = status.over_budget ? 'Over Budget' :
                                      status.needs_alert ? 'Approaching Limit' : 'On Track';
                    const progressColor = status.over_budget ? 'var(--danger)' :
                                         status.needs_alert ? 'var(--warning)' : 'var(--success)';
                    
                    document.getElementById('budgetStatus').innerHTML = `
                        <div class="cost-metric">
                            <span class="metric-label">
                                <span class="status-indicator ${statusClass}"></span>Status
                            </span>
                            <span class="metric-value">${statusText}</span>
                        </div>
                        <div class="cost-metric">
                            <span class="metric-label">Spent</span>
                            <span class="metric-value">$${status.current_spending.toFixed(2)} / $${status.monthly_budget.toFixed(2)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(status.usage_percent, 100)}%; background: ${progressColor};"></div>
                        </div>
                        <div style="text-align: center; font-size: 12px; color: var(--text-muted);">
                            ${status.usage_percent.toFixed(1)}% of budget used
                        </div>
                    `;
                }
                
            } catch (error) {
                document.getElementById('budgetStatus').innerHTML = `<div class="error">Error loading budget status</div>`;
            }
        }
        
        async function loadChart(endpoint, containerId) {
            try {
                const data = await fetchApi(endpoint);
                document.getElementById(containerId).innerHTML = `<img src="${data.image}" alt="Cost Chart">`;
            } catch (error) {
                document.getElementById(containerId).innerHTML = `<div class="error">Chart unavailable: ${error.message}</div>`;
            }
        }
        
        async function setBudget() {
            const budget = parseFloat(document.getElementById('budgetAmount').value);
            const threshold = parseInt(document.getElementById('budgetThreshold').value);
            
            if (!budget || budget <= 0) {
                alert('Please enter a valid budget amount');
                return;
            }
            
            try {
                const response = await fetch('/api/set_budget', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ budget, threshold })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Budget set successfully!');
                    await loadBudgetStatus();
                } else {
                    alert('Error setting budget: ' + data.error);
                }
            } catch (error) {
                alert('Error setting budget: ' + error.message);
            }
        }
        
        async function refreshAll() {
            currentDays = parseInt(document.getElementById('daySelect').value);
            
            // Show loading states
            document.getElementById('costMetrics').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('usageMetrics').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('budgetStatus').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('costChartContainer').innerHTML = '<div class="loading">Loading chart...</div>';
            document.getElementById('modelComparisonContainer').innerHTML = '<div class="loading">Loading comparison...</div>';
            document.getElementById('usagePatternsContainer').innerHTML = '<div class="loading">Loading patterns...</div>';
            
            // Load all data
            await Promise.all([
                loadCostSummary(),
                loadBudgetStatus(),
                loadChart(`/api/cost_chart?days=${currentDays}`, 'costChartContainer'),
                loadChart('/api/model_comparison', 'modelComparisonContainer'),
                loadChart(`/api/usage_patterns?days=${currentDays}`, 'usagePatternsContainer')
            ]);
        }
        
        async function exportReport() {
            try {
                const data = await fetchApi(`/api/cost_summary?days=${currentDays}`);
                const report = JSON.stringify(data.data, null, 2);
                
                const blob = new Blob([report], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `duckbot_cost_report_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error downloading report: ' + error.message);
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initial load
            refreshAll();
            
            // Controls
            document.getElementById('daySelect').addEventListener('change', refreshAll);
            document.getElementById('refreshData').addEventListener('click', refreshAll);
            document.getElementById('exportReport').addEventListener('click', exportReport);
            
            // Auto-refresh every 5 minutes
            setInterval(refreshAll, 5 * 60 * 1000);
        });
    </script>
</body>
</html>