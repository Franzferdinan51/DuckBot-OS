<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D AI Robot Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #60a5fa;
            --accent-hover: #3b82f6;
            --danger: #ef4444;
            --success: #22c55e;
            --border: #334155;
            --card-bg: #1e293b;
            --glow: 0 0 15px rgba(96, 165, 250, 0.5);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        body {
            background: linear-gradient(135deg, var(--bg-primary), #0c1220);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        #app {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        #scene-container {
            flex: 1;
            position: relative;
            cursor: grab;
            min-height: 60vh; /* Mobile-friendly minimum height */
        }
        #scene-container:active {
            cursor: grabbing;
        }
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(96, 165, 250, 0.2);
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #chat-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 25px;
            z-index: 10;
        }
        #chat-ui {
            max-width: 750px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.85);
            border-radius: 50px;
            padding: 8px;
            display: flex;
            align-items: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3), var(--glow);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
        }
        #settings-btn, #mic-btn, #send-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }
        #settings-btn:hover, #mic-btn:hover {
            background-color: rgba(51, 65, 85, 0.5);
            transform: translateY(-2px);
        }
        #mic-btn.listening {
            color: var(--danger);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        #message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 16px 20px;
            font-size: 16px;
            outline: none;
        }
        #message-input::placeholder {
            color: var(--text-secondary);
        }
        #send-btn {
             background: linear-gradient(90deg, var(--accent), #8b5cf6);
             margin-left: 5px;
        }
        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
        }
        #send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            background: var(--border);
            box-shadow: none;
        }
        #settings-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: linear-gradient(145deg, var(--card-bg), #1a2234);
            border-radius: 16px;
            padding: 35px;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), var(--glow);
            border: 1px solid var(--border);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .modal-title {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .close-btn:hover {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .form-control {
            width: 100%;
            padding: 14px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }
        .toggle-group {
            display: flex;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .toggle-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .toggle-btn.active {
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            color: white;
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.3);
        }
        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }
        .btn-secondary {
            background-color: var(--border);
            color: var(--text-primary);
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            color: white;
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
        }
        .btn-secondary:hover {
            background-color: #475569;
            transform: translateY(-2px);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(96, 165, 250, 0.4);
        }
        .info-box {
            padding: 18px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            border-left: 4px solid var(--accent);
            margin-top: 20px;
        }
        .info-box p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }
        datalist {
            display: none;
        }
        #status-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            color: var(--text-secondary);
            backdrop-filter: blur(5px);
            border: 1px solid var(--border);
            z-index: 20;
            transition: all 0.3s ease;
        }
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .logo {
                font-size: 2rem;
            }
            #chat-container {
                padding: 15px;
            }
            #chat-ui {
                border-radius: 25px;
                padding: 6px;
            }
            #message-input {
                padding: 12px 16px;
                font-size: 14px;
            }
            #settings-btn, #mic-btn, #send-btn {
                padding: 10px;
            }
            .modal-content {
                padding: 25px;
                width: 95%;
            }
            .modal-title {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="scene-container"></div>
        <div id="status-bar">Ready</div>
        <div id="loading-overlay">
            <div class="logo">AI ROBOT COMPANION</div>
            <div class="spinner"></div>
            <h2>Loading 3D Model...</h2>
            <p id="loading-text">Initializing systems</p>
        </div>
        <div id="chat-container">
            <div id="chat-ui">
                <button id="settings-btn" aria-label="Settings">
                    <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <input type="text" id="message-input" placeholder="Ask me anything..." autocomplete="off">
                <button id="mic-btn" aria-label="Use Microphone">
                    <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>
                <button id="send-btn" aria-label="Send">
                    <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="settings-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Settings</h2>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label" for="avatar-select">Avatar</label>
                    <select id="avatar-select" class="form-control">
                        <option value="https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb">Robot Expressive</option>
                        <option value="https://threejs.org/examples/models/gltf/Michelle.glb">Michelle</option>
                        <option value="https://threejs.org/examples/models/gltf/Xbot.glb">Xbot</option>
                        <option value="https://threejs.org/examples/models/gltf/Flamingo.glb">Flamingo</option>
                        <option value="https://threejs.org/examples/models/gltf/Stork.glb">Stork</option>
                        <option value="https://threejs.org/examples/models/gltf/Parrot.glb">Parrot</option>
                        <option value="https://threejs.org/examples/models/gltf/Soldier.glb">Soldier</option>
                        <option value="https://threejs.org/examples/models/gltf/Knight.glb">Knight</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="voice-select">Voice</label>
                    <select id="voice-select" class="form-control">
                        <option value="">Browser Default</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">API Provider</label>
                    <div class="toggle-group">
                        <button id="gemini-toggle" class="toggle-btn active">Gemini</button>
                        <button id="openrouter-toggle" class="toggle-btn">OpenRouter</button>
                    </div>
                </div>
                <div id="gemini-settings">
                    <div class="form-group">
                        <label class="form-label" for="gemini-model">Gemini Model</label>
                        <select id="gemini-model" class="form-control">
                            <option value="gemini-pro">gemini-pro</option>
                            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                        </select>
                    </div>
                    <div class="info-box">
                        <p>The Google Gemini API key is configured on the server.</p>
                    </div>
                </div>
                <div id="openrouter-settings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="openrouter-key">OpenRouter API Key</label>
                        <input type="password" id="openrouter-key" class="form-control" placeholder="Enter your API key">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="openrouter-model">OpenRouter Model</label>
                        <input list="openrouter-models-list" id="openrouter-model" class="form-control" placeholder="Select or type a model">
                        <datalist id="openrouter-models-list"></datalist>
                    </div>
                </div>
                <div class="button-group">
                    <button id="cancel-settings" class="btn btn-secondary">Cancel</button>
                    <button id="save-settings" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        // DOM Elements
        const sceneContainer = document.getElementById('scene-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeBtn = document.querySelector('.close-btn');
        const cancelSettingsBtn = document.getElementById('cancel-settings');
        const saveSettingsBtn = document.getElementById('save-settings');
        const avatarSelect = document.getElementById('avatar-select');
        const voiceSelect = document.getElementById('voice-select');
        const geminiToggle = document.getElementById('gemini-toggle');
        const openrouterToggle = document.getElementById('openrouter-toggle');
        const geminiSettings = document.getElementById('gemini-settings');
        const openrouterSettings = document.getElementById('openrouter-settings');
        const geminiModelSelect = document.getElementById('gemini-model');
        const openrouterKeyInput = document.getElementById('openrouter-key');
        const openrouterModelInput = document.getElementById('openrouter-model');
        const openrouterModelsList = document.getElementById('openrouter-models-list');
        const statusBar = document.getElementById('status-bar');
        // State
        let scene, camera, renderer, controls, clock;
        let currentModel = null;
        let headMesh = null;
        let morphTargetDictionary = null;
        let morphTargetInfluences = null;
        let isModelLoaded = false;
        let isLoading = false;
        let isListening = false;
        let recognition = null;
        let voices = [];
        // Settings
        const defaultSettings = {
            avatarUrl: 'https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb',
            apiProvider: 'gemini',
            geminiModel: 'gemini-1.5-flash',
            openRouterApiKey: '',
            openRouterModel: 'google/gemini-flash-1.5',
            speechVoiceURI: null
        };
        let settings = {...defaultSettings};
        let tempSettings = {...defaultSettings};
        // Model-specific camera settings - UPDATED FOR BETTER POSITIONING
        const modelCameraSettings = {
            'https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb': { position: [0, 1.0, 3.5], target: [0, 1.0, 0] },
            'https://threejs.org/examples/models/gltf/Michelle.glb': { position: [0, 0.8, 2.5], target: [0, 0.8, 0] },
            'https://threejs.org/examples/models/gltf/Xbot.glb': { position: [0, 0.8, 2.5], target: [0, 0.8, 0] },
            'https://threejs.org/examples/models/gltf/Flamingo.glb': { position: [0, 0.4, 1.8], target: [0, 0.4, 0] },
            'https://threejs.org/examples/models/gltf/Stork.glb': { position: [0, 0.4, 1.8], target: [0, 0.4, 0] },
            'https://threejs.org/examples/models/gltf/Parrot.glb': { position: [0, 0.25, 1.2], target: [0, 0.25, 0] },
            'https://threejs.org/examples/models/gltf/Soldier.glb': { position: [0, 0.8, 2.5], target: [0, 0.8, 0] },
            'https://threejs.org/examples/models/gltf/Knight.glb': { position: [0, 0.8, 2.5], target: [0, 0.8, 0] },
            'default': { position: [0, 0.8, 2.5], target: [0, 0.8, 0] }
        };
        // Initialize the application
        function init() {
            updateStatus('Initializing application...');
            loadSettings();
            setupScene();
            loadModel();
            setupEventListeners();
            setupSpeechRecognition();
            populateVoiceList();
            fetchOpenRouterModels();
        }
        // Three.js Scene Setup
        function setupScene() {
            updateStatus('Setting up 3D scene...');
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f172a);
            scene.fog = new THREE.Fog(0x0f172a, 8, 30);
            // Camera with default position
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000); // Reduced FOV for less zoom
            const defaultCamSettings = modelCameraSettings['default'];
            camera.position.set(...defaultCamSettings.position);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit pixel ratio for mobile
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            sceneContainer.appendChild(renderer.domElement);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(...defaultCamSettings.target);
            controls.enablePan = true;
            controls.enableZoom = true;
            controls.minDistance = 1;
            controls.maxDistance = 12; // Reduced max distance
            controls.dampingFactor = 0.07;
            controls.enableDamping = true;
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
            scene.add(ambientLight);
            const keyLight = new THREE.DirectionalLight(0xffe0bd, 2.5);
            keyLight.position.set(3, 5, 2);
            keyLight.castShadow = true;
            keyLight.shadow.mapSize.width = 1024;
            keyLight.shadow.mapSize.height = 1024;
            scene.add(keyLight);
            const fillLight = new THREE.DirectionalLight(0xd0e0ff, 1.5);
            fillLight.position.set(-3, 2, 1);
            scene.add(fillLight);
            const rimLight = new THREE.DirectionalLight(0x40a0ff, 1.0);
            rimLight.position.set(0, 2, -5);
            scene.add(rimLight);
            const hemiLight = new THREE.HemisphereLight(0xffffbb, 0x080820, 0.5);
            scene.add(hemiLight);
            // Ground and grid
            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: 0x1e293b,
                roughness: 0.8,
                metalness: 0.2
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            const gridHelper = new THREE.GridHelper(20, 20, 0x334155, 0x1e293b);
            scene.add(gridHelper);
            animate();
        }
        function loadModel() {
            const modelUrl = settings.avatarUrl;
            const spinner = loadingOverlay.querySelector('.spinner');
            if(spinner) spinner.style.display = 'block';
            loadingText.innerHTML = 'Initializing systems';
            isModelLoaded = false;
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.opacity = '1';
            updateStatus('Loading 3D model...');
            if (currentModel) {
                scene.remove(currentModel);
                currentModel = null;
            }
            headMesh = null;
            morphTargetDictionary = null;
            morphTargetInfluences = null;
            const loader = new GLTFLoader();
            loader.load(
                modelUrl,
                (gltf) => {
                    currentModel = gltf.scene;
                    scene.add(currentModel);
                    // Center the model
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    // Position model at origin - FIXED FOR GROUND FLUSHNESS
                    currentModel.position.sub(center);
                    // Move model up so feet are flush with ground
                    const minY = box.min.y;
                    currentModel.position.y -= minY;
                    // Apply model-specific camera settings
                    const camSettings = modelCameraSettings[modelUrl] || modelCameraSettings['default'];
                    camera.position.set(...camSettings.position);
                    controls.target.set(...camSettings.target);
                    // Find head mesh with morph targets
                    currentModel.traverse((node) => {
                       if (!headMesh && node.isMesh && node.morphTargetInfluences) {
                           headMesh = node;
                           morphTargetInfluences = node.morphTargetInfluences;
                           morphTargetDictionary = node.morphTargetDictionary;
                       }
                    });
                    if (!morphTargetDictionary && !headMesh) {
                         console.warn("Could not find any mesh with morph targets.");
                    } else {
                         console.log("Morph targets found:", morphTargetDictionary);
                    }
                    isModelLoaded = true;
                    hideLoadingOverlay();
                },
                (xhr) => {
                    const percent = xhr.total > 0 ? Math.round((xhr.loaded / xhr.total) * 100) : 0;
                    loadingText.textContent = `Downloading: ${percent}%`;
                    updateStatus(`Loading model... ${percent}%`);
                },
                (error) => {
                    console.error('An error happened during model loading:', error);
                    if (spinner) spinner.style.display = 'none';
                    loadingText.innerHTML = '<strong>Error loading model.</strong>';
                    updateStatus('Error: Model load failed');
                    isModelLoaded = false;
                }
            );
        }
        function hideLoadingOverlay() {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                updateStatus('Ready');
            }, 500);
        }
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            controls.update();
            renderer.render(scene, camera);
        }
        function setupEventListeners() {
            window.addEventListener('resize', onWindowResize);
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
            micBtn.addEventListener('click', toggleListening);
            settingsBtn.addEventListener('click', openSettings);
            closeBtn.addEventListener('click', closeSettings);
            cancelSettingsBtn.addEventListener('click', closeSettings);
            saveSettingsBtn.addEventListener('click', saveSettingsAndReload);
            avatarSelect.addEventListener('change', (e) => tempSettings.avatarUrl = e.target.value);
            voiceSelect.addEventListener('change', (e) => tempSettings.speechVoiceURI = e.target.value || null);
            geminiModelSelect.addEventListener('change', (e) => tempSettings.geminiModel = e.target.value);
            openrouterKeyInput.addEventListener('input', (e) => tempSettings.openRouterApiKey = e.target.value);
            openrouterModelInput.addEventListener('input', (e) => tempSettings.openRouterModel = e.target.value);
            geminiToggle.addEventListener('click', () => { tempSettings.apiProvider = 'gemini'; updateSettingsForm(); });
            openrouterToggle.addEventListener('click', () => { tempSettings.apiProvider = 'openrouter'; updateSettingsForm(); });
        }
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        function updateStatus(message) {
            statusBar.textContent = message;
        }
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isLoading || !isModelLoaded) return;
            if (settings.apiProvider === 'openrouter' && !settings.openRouterApiKey) {
                alert("OpenRouter API key not set.");
                openSettings();
                return;
            }
            messageInput.value = '';
            setIsLoading(true);
            updateStatus('Thinking...');
            try {
                const responseText = await getAIResponse(message);
                updateStatus('Speaking...');
                speakAndAnimate(responseText);
            } catch (error) {
                console.error("Failed to get AI response:", error);
                updateStatus('Error occurred');
                alert(`Sorry, an error occurred: ${error.message || "Unknown error"}`);
                setIsLoading(false);
            }
        }
        function setIsLoading(loading) {
            isLoading = loading;
            sendBtn.disabled = loading;
            messageInput.disabled = loading;
            micBtn.disabled = loading;
            if (loading) {
                sendBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0;"></div>';
            } else {
                sendBtn.innerHTML = '<svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
            }
        }
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Speech recognition not supported.");
                micBtn.style.display = 'none';
                return;
            }
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                if (transcript) {
                    messageInput.value = transcript;
                    sendMessage();
                }
            };
            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('listening');
                if (!isLoading) updateStatus('Ready');
            };
            recognition.onerror = (event) => {
                if (event.error !== 'no-speech') {
                    console.error("Speech recognition error:", event.error);
                    updateStatus('Speech recognition error');
                }
            };
        }
        function toggleListening() {
            if (!recognition) return;
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
                isListening = true;
                micBtn.classList.add('listening');
                updateStatus('Listening...');
            }
        }
        function openSettings() {
            tempSettings = {...settings};
            updateSettingsForm();
            settingsModal.style.display = 'flex';
        }
        function closeSettings() {
            settingsModal.style.display = 'none';
        }
        function updateSettingsForm() {
            avatarSelect.value = tempSettings.avatarUrl;
            voiceSelect.value = tempSettings.speechVoiceURI || '';
            if (tempSettings.apiProvider === 'gemini') {
                geminiToggle.classList.add('active');
                openrouterToggle.classList.remove('active');
                geminiSettings.style.display = 'block';
                openrouterSettings.style.display = 'none';
            } else {
                openrouterToggle.classList.add('active');
                geminiToggle.classList.remove('active');
                openrouterSettings.style.display = 'block';
                geminiSettings.style.display = 'none';
            }
            geminiModelSelect.value = tempSettings.geminiModel;
            openrouterKeyInput.value = tempSettings.openRouterApiKey;
            openrouterModelInput.value = tempSettings.openRouterModel;
        }
        function saveSettingsAndReload() {
            const oldAvatarUrl = settings.avatarUrl;
            settings = {...tempSettings};
            saveSettingsToStorage();
            closeSettings();
            updateStatus('Settings saved');
            if (oldAvatarUrl !== settings.avatarUrl) {
                loadModel();
            }
        }
        function populateVoiceList() {
            voices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
            voiceSelect.innerHTML = '<option value="">Browser Default</option>';
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.voiceURI;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
        }
        window.speechSynthesis.onvoiceschanged = populateVoiceList;
        function speakAndAnimate(text) {
            if (!window.speechSynthesis) return;
            const utterance = new SpeechSynthesisUtterance(text);
            if (settings.speechVoiceURI) {
                const selectedVoice = voices.find(voice => voice.voiceURI === settings.speechVoiceURI);
                if (selectedVoice) utterance.voice = selectedVoice;
            }
            resetMorphTargets();
            let mouthMorphTargetName = null;
            if (morphTargetDictionary) {
                const possibleNames = ['mouthOpen', 'jawOpen', 'MouthOpen', 'JawOpen', 'vrc.v_oh', 'viseme_O', 'mouth', 'jaw_open'];
                mouthMorphTargetName = possibleNames.find(name => name in morphTargetDictionary) || Object.keys(morphTargetDictionary).find(key => key.toLowerCase().includes('mouth')) || null;
            }
            utterance.onboundary = (event) => {
                if (event.name === 'word' && mouthMorphTargetName) {
                    setMorphTargetInfluence(mouthMorphTargetName, 1.0);
                    setTimeout(() => setMorphTargetInfluence(mouthMorphTargetName, 0), 150);
                }
            };
            utterance.onend = () => {
                resetMorphTargets();
                setIsLoading(false);
                updateStatus('Ready');
            };
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }
        function setMorphTargetInfluence(name, value) {
            if (headMesh && morphTargetDictionary && morphTargetInfluences) {
                const index = morphTargetDictionary[name];
                if (index !== undefined) morphTargetInfluences[index] = value;
            }
        }
        function resetMorphTargets() {
            if (morphTargetInfluences) {
                for (let i = 0; i < morphTargetInfluences.length; i++) {
                    morphTargetInfluences[i] = 0;
                }
            }
        }
        async function getAIResponse(prompt) {
            if (settings.apiProvider === 'gemini') {
                return getGeminiResponse(prompt);
            } else {
                return getOpenRouterResponse(prompt);
            }
        }
        async function getGeminiResponse(prompt) {
            console.log(`Simulating Gemini API call for model: ${settings.geminiModel}`);
            const mockResponses = [
                "Hello there! I am your 3D robotic assistant.",
                "That is an interesting question. Let me analyze...",
                "My purpose is to assist you with information and tasks.",
                "The universe of data is vast and fascinating.",
                "Processing... Please stand by for a synthesized response."
            ];
            await new Promise(resolve => setTimeout(resolve, 1500));
            return mockResponses[Math.floor(Math.random() * mockResponses.length)];
        }
        async function getOpenRouterResponse(prompt) {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${settings.openRouterApiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: settings.openRouterModel,
                    messages: [{ role: "user", content: prompt }]
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`OpenRouter API error: ${errorData.error?.message || response.statusText}`);
            }
            const data = await response.json();
            return data.choices?.[0]?.message?.content || "I could not generate a response.";
        }
        async function fetchOpenRouterModels() {
            try {
                const response = await fetch('https://openrouter.ai/api/v1/models');
                const data = await response.json();
                const models = data.data.filter((model) => model?.pricing?.prompt === "0" && model?.pricing?.completion === "0") || [];
                openrouterModelsList.innerHTML = '';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    openrouterModelsList.appendChild(option);
                });
            } catch (error) {
                console.error("Failed to fetch OpenRouter models:", error);
            }
        }
        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem('aiTalkingHeadSettings');
                if (storedSettings) {
                    settings = {...defaultSettings, ...JSON.parse(storedSettings)};
                }
            } catch (error) {
                console.error("Failed to load settings:", error);
            }
        }
        function saveSettingsToStorage() {
            try {
                localStorage.setItem('aiTalkingHeadSettings', JSON.stringify(settings));
            } catch (error) {
                console.error("Failed to save settings:", error);
            }
        }
        init();
    </script>
</body>
</html>